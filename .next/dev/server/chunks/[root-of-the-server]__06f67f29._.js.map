{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/kanata/calenderapp/app/api/ocr/route.ts"],"sourcesContent":["// app/api/ocr/route.ts\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport Anthropic from \"@anthropic-ai/sdk\";\nimport type { OCRResult, APIResponse } from \"@/lib/types\";\n\nconst anthropic = new Anthropic({\n  apiKey: process.env.ANTHROPIC_API_KEY,\n});\n\nexport async function POST(request: NextRequest) {\n  try {\n    // 明確な早期チェック: APIキーが設定されていなければわかりやすく返す\n    if (!process.env.ANTHROPIC_API_KEY) {\n      console.error(\n        \"Anthropic API key is not configured (ANTRHOPIC_API_KEY missing)\"\n      );\n      return NextResponse.json(\n        {\n          success: false,\n          error:\n            \"サーバー側の設定で Anthropic API キーが設定されていません。環境変数 ANTHROPIC_API_KEY を確認してください。\",\n        },\n        { status: 500 }\n      );\n    }\n\n    const formData = await request.formData();\n    const image = formData.get(\"image\") as string;\n\n    if (!image) {\n      return NextResponse.json<APIResponse<null>>(\n        {\n          success: false,\n          error: \"画像がアップロードされていません\",\n        },\n        { status: 400 }\n      );\n    }\n\n    // Base64からmimeTypeとデータを抽出\n    const mimeTypeMatch = image.match(/data:([^;]+);/);\n    const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : \"image/jpeg\";\n    const base64Data = image.split(\",\")[1] || image;\n\n    // 名前（フォームで渡された場合）\n    const name = (formData.get(\"name\") as string) || \"\";\n\n    // Claude APIで画像を解析\n    // 名前が渡されていれば、その名前に関連するシフトのみ抽出するよう指示を追加します。\n    const nameInstruction = name\n      ? `\\n\\n注意: 画像中に氏名や担当者名が記載されている場合は、名前が \"${name}\" に該当する予定（シフト）のみを抽出してください。該当がない場合は空配列を返してください。`\n      : \"\";\n\n    // より構造化されたJSONを返すようプロンプトを強化します。\n    const prompt =\n      `この画像からスケジュール・予定情報を抽出してください。\\n\\n必ず返す形式: JSON配列。配列の各要素は少なくとも title を含むオブジェクトで、可能なら以下フィールドを出力してください: date, startTime, endTime, title, description, category, assignedTo (配列), rawText (文字列)。assignedTo が空でも空配列を返してください。\\n\\n出力は\"JSONのみ\"にしてください。余計な説明や注釈、マークダウンは一切含めないでください。日付や時間が読み取れない場合は null を使用し、予定が無ければ空配列 [] を返してください。\\n\\n以下に複数の具体例を示します。必ず同じフィールド名で返してください。\\n\\n例1（複数名・日付あり）:\\n[\\n  {\\n    \"date\": \"2025-11-20\",\\n    \"startTime\": \"09:00\",\\n    \"endTime\": \"12:00\",\\n    \"title\": \"会議（営業部）\",\\n    \"description\": \"来期予算の打ち合わせ\",\\n    \"category\": \"work\",\\n    \"assignedTo\": [\"田中 太郎\", \"佐藤 花子\"],\\n    \"rawText\": \"11/20 9:00-12:00 田中/佐藤 会議 来期予算\"\\n  }\\n]\\n\\n例2（氏名が画像に明記され、該当者のみ抽出）:\\n[\\n  {\\n    \"date\": \"2025-11-21\",\\n    \"startTime\": \"14:00\",\\n    \"endTime\": \"15:00\",\\n    \"title\": \"面談\",\\n    \"description\": \"新人面談\",\\n    \"category\": \"work\",\\n    \"assignedTo\": [\"山田 太郎\"],\\n    \"rawText\": \"11/21 山田 太郎 14:00 面談\"\\n  }\\n]\\n\\n例3（日時読み取り困難）:\\n[\\n  {\\n    \"date\": null,\\n    \"startTime\": null,\\n    \"endTime\": null,\\n    \"title\": \"納期未定の打ち合わせ\",\\n    \"description\": \"詳細は未記入\",\\n    \"category\": \"other\",\\n    \"assignedTo\": [],\\n    \"rawText\": \"未定 打ち合わせ\"\\n  }\\n]\\n\\n注: assignedTo が得られない場合でも空の配列を返すこと、rawText には可能な限り元テキスト断片を入れることを徹底してください。` +\n      nameInstruction;\n\n    let message;\n    try {\n      message = await anthropic.messages.create({\n        model: \"claude-sonnet-4-20250514\",\n        max_tokens: 2000,\n        messages: [\n          {\n            role: \"user\",\n            content: [\n              {\n                type: \"image\",\n                source: {\n                  type: \"base64\",\n                  media_type: mimeType as\n                    | \"image/jpeg\"\n                    | \"image/png\"\n                    | \"image/gif\"\n                    | \"image/webp\",\n                  data: base64Data,\n                },\n              },\n              {\n                type: \"text\",\n                text: prompt,\n              },\n            ],\n          },\n        ],\n      });\n    } catch (llmError) {\n      console.error(\"Anthropic API error:\", llmError);\n      const friendly = (llmError as any)?.message || String(llmError);\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"OCR 処理で外部 API からエラーが返りました: \" + friendly,\n        },\n        { status: 502 }\n      );\n    }\n\n    // レスポンスからテキストを抽出\n    const responseText = message.content\n      .filter((block) => block.type === \"text\")\n      .map((block) => (block.type === \"text\" ? block.text : \"\"))\n      .join(\"\");\n\n    // JSONをパース\n    let schedules: OCRResult[] = [];\n    try {\n      // マークダウンのコードブロックを除去\n      const cleanedText = responseText\n        .replace(/```json\\n?/g, \"\")\n        .replace(/```\\n?/g, \"\")\n        .trim();\n\n      schedules = JSON.parse(cleanedText);\n\n      // 配列でない場合は配列に変換\n      if (!Array.isArray(schedules)) {\n        schedules = [schedules];\n      }\n\n      // サーバー側でも名前フィルタをかける（クライアントから name が渡されている場合）\n      if (name && name.trim()) {\n        const nmRaw = name.trim();\n\n        const normalize = (s?: string) => {\n          if (!s) return \"\";\n          // 小文字化・空白削除・全角英数字を半角化・正規化\n          const fwToHw = (str: string) =>\n            str\n              .replace(/[\u0001-]/g, (ch) => ch)\n              .replace(/[！-～]/g, (c) =>\n                String.fromCharCode(c.charCodeAt(0) - 0xfee0)\n              );\n          return fwToHw(s)\n            .normalize(\"NFKC\")\n            .toLowerCase()\n            .replace(/\\s+/g, \"\")\n            .replace(/[\\p{P}\\p{S}]/gu, \"\");\n        };\n\n        // レーベンシュタイン距離（簡易実装）\n        const levenshtein = (a: string, b: string) => {\n          const dp: number[][] = Array.from({ length: a.length + 1 }, () =>\n            new Array(b.length + 1).fill(0)\n          );\n          for (let i = 0; i <= a.length; i++) dp[i][0] = i;\n          for (let j = 0; j <= b.length; j++) dp[0][j] = j;\n          for (let i = 1; i <= a.length; i++) {\n            for (let j = 1; j <= b.length; j++) {\n              const cost = a[i - 1] === b[j - 1] ? 0 : 1;\n              dp[i][j] = Math.min(\n                dp[i - 1][j] + 1,\n                dp[i][j - 1] + 1,\n                dp[i - 1][j - 1] + cost\n              );\n            }\n          }\n          return dp[a.length][b.length];\n        };\n\n        const nm = normalize(nmRaw);\n\n        const matchesName = (item: OCRResult) => {\n          // 1) まず assignedTo があればそちらを優先して照合\n          const as = (item as any).assignedTo as string[] | undefined;\n          if (Array.isArray(as) && as.length > 0) {\n            for (const person of as) {\n              const p = normalize(person);\n              if (!p) continue;\n              if (p.includes(nm) || nm.includes(p)) return true;\n              const maxDist = Math.max(\n                1,\n                Math.floor(Math.max(nm.length, p.length) * 0.3)\n              );\n              if (levenshtein(p, nm) <= maxDist) return true;\n            }\n            return false;\n          }\n\n          // 2) 次に title/description/rawText を使って照合\n          const fields = [item.title, item.description, (item as any).rawText]\n            .filter(Boolean)\n            .map((s) => normalize(String(s)));\n\n          for (const f of fields) {\n            if (f.includes(nm) || nm.includes(f)) return true;\n            if (levenshtein(f, nm) <= Math.max(1, Math.floor(nm.length * 0.25)))\n              return true;\n          }\n\n          return false;\n        };\n\n        const filtered = schedules.filter(matchesName);\n\n        // 指示通り、該当がなければ空配列を返す\n        schedules = filtered;\n      }\n    } catch (parseError) {\n      console.error(\"JSON parse error:\", parseError);\n      console.error(\"Response text:\", responseText);\n\n      return NextResponse.json<APIResponse<null>>(\n        {\n          success: false,\n          error:\n            \"画像から予定を抽出できませんでした。別の画像をお試しください。\",\n        },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json<APIResponse<OCRResult[]>>({\n      success: true,\n      data: schedules,\n    });\n  } catch (error) {\n    console.error(\"OCR processing error:\", error);\n\n    return NextResponse.json<APIResponse<null>>(\n      {\n        success: false,\n        error: \"OCR処理中にエラーが発生しました\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}